# =============================================================================
# Desktop Index - Dockerfile
# =============================================================================
# Python 3.11 ベースのアプリケーションイメージを構築します。
#
# 含まれるコンポーネント:
#   - FastAPI Webアプリケーション
#   - ファイルクローラー
#   - ドキュメントパーサー（PDF、Word、Excel対応）
#
# ビルド方法:
#   docker build -t desktopindex .
# =============================================================================

FROM python:3.11-slim

# ---------------------------------------------------------------------------
# 環境変数の設定
# ---------------------------------------------------------------------------
# PYTHONUNBUFFERED: 標準出力をバッファリングしない（ログがリアルタイムで表示される）
# PYTHONDONTWRITEBYTECODE: .pycファイルを作成しない（コンテナサイズ削減）
# ---------------------------------------------------------------------------
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# ---------------------------------------------------------------------------
# 作業ディレクトリの設定
# ---------------------------------------------------------------------------
WORKDIR /app

# ---------------------------------------------------------------------------
# システム依存パッケージのインストール
# ---------------------------------------------------------------------------
# curl: ヘルスチェック用
# libmagic1: ファイルタイプ検出用
# ---------------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    libmagic1 \
    && rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------------------------
# Python依存パッケージのインストール
# ---------------------------------------------------------------------------
# requirements.txt を先にコピーすることで、ソースコード変更時の
# 再ビルドを高速化（Dockerのレイヤーキャッシュを活用）
# ---------------------------------------------------------------------------
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ---------------------------------------------------------------------------
# アプリケーションコードのコピー
# ---------------------------------------------------------------------------
COPY src/ ./src/
COPY config.yaml .

# ---------------------------------------------------------------------------
# ポートの公開
# ---------------------------------------------------------------------------
# FastAPIアプリケーションは8000番ポートで動作
# ---------------------------------------------------------------------------
EXPOSE 8000

# ---------------------------------------------------------------------------
# アプリケーションの起動
# ---------------------------------------------------------------------------
# uvicorn: 高速なASGIサーバー
# --host 0.0.0.0: 全てのネットワークインターフェースでリッスン
# --reload: 開発時のホットリロード（本番では削除推奨）
# ---------------------------------------------------------------------------
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
