{% extends "base.html" %}
<!--
=============================================================================
Desktop Index - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒšãƒ¼ã‚¸
=============================================================================
ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹çµ±è¨ˆã€ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼çŠ¶æ…‹ã‚’è¡¨ç¤ºã™ã‚‹ãƒšãƒ¼ã‚¸ã§ã™ã€‚
ç®¡ç†è€…å‘ã‘ã®æƒ…å ±ã¨æ“ä½œãƒœã‚¿ãƒ³ã‚’æä¾›ã—ã¾ã™ã€‚
=============================================================================
-->

{% block content %}
<div class="status-page">
    <h1 class="page-title">ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h1>

    <!-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹çµ±è¨ˆ -->
    <section class="status-section">
        <h2 class="section-title">ğŸ“Š ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹çµ±è¨ˆ</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ index_stats.numberOfDocuments | default(0) }}</div>
                <div class="stat-label">ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ 'å‡¦ç†ä¸­' if index_stats.isIndexing else 'å¾…æ©Ÿä¸­' }}</div>
                <div class="stat-label">ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹çŠ¶æ…‹</div>
            </div>
        </div>
    </section>

    <!-- ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼çŠ¶æ…‹ -->
    <section class="status-section">
        <h2 class="section-title">ğŸ•·ï¸ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼çŠ¶æ…‹</h2>
        <div class="status-info">
            <div class="info-row">
                <span class="info-label">å®Ÿè¡ŒçŠ¶æ…‹:</span>
                <span class="info-value status-badge {% if scheduler_status.is_running %}running{% else %}stopped{% endif %}">
                    {{ 'å®Ÿè¡Œä¸­' if scheduler_status.is_running else 'åœæ­¢ä¸­' }}
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">æœ€çµ‚å®Ÿè¡Œ:</span>
                <span class="info-value">{{ scheduler_status.last_run or 'æœªå®Ÿè¡Œ' }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">æ¬¡å›å®Ÿè¡Œ:</span>
                <span class="info-value">{{ scheduler_status.next_run or 'æœªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«' }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«:</span>
                <span class="info-value">{{ scheduler_status.files_processed | default(0) }} ä»¶</span>
            </div>
            {% if scheduler_status.current_path %}
            <div class="info-row">
                <span class="info-label">ç¾åœ¨å‡¦ç†ä¸­:</span>
                <span class="info-value path">{{ scheduler_status.current_path }}</span>
            </div>
            {% endif %}
        </div>

        <!-- ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼åˆ¶å¾¡ãƒœã‚¿ãƒ³ -->
        <div class="control-buttons">
            <button id="startCrawlBtn" class="btn btn-primary" onclick="startCrawl()">
                â–¶ï¸ ã‚¯ãƒ­ãƒ¼ãƒ«é–‹å§‹
            </button>
            <button id="stopCrawlBtn" class="btn btn-secondary" onclick="stopCrawl()">
                â¹ï¸ ã‚¯ãƒ­ãƒ¼ãƒ«åœæ­¢
            </button>
        </div>
    </section>

    <!-- è¨­å®šæƒ…å ± -->
    <section class="status-section">
        <h2 class="section-title">âš™ï¸ è¨­å®š</h2>
        <div class="status-info">
            <div class="info-row">
                <span class="info-label">ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡:</span>
                <span class="info-value">
                    <ul class="path-list">
                        {% for path in settings.scan_paths %}
                        <li>{{ path }}</li>
                        {% endfor %}
                    </ul>
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">ã‚¹ã‚­ãƒ£ãƒ³é–“éš”:</span>
                <span class="info-value">{{ settings.scan_interval_minutes }} åˆ†</span>
            </div>
            <div class="info-row">
                <span class="info-label">å¯¾è±¡æ‹¡å¼µå­:</span>
                <span class="info-value">
                    {% for ext in settings.supported_extensions %}
                    <span class="extension-badge">{{ ext }}</span>
                    {% endfor %}
                    ...
                </span>
            </div>
        </div>
    </section>

    <!-- å±é™ºãªæ“ä½œ -->
    <section class="status-section danger-zone">
        <h2 class="section-title">âš ï¸ å±é™ºãªæ“ä½œ</h2>
        <p class="warning-text">ä»¥ä¸‹ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚</p>
        <button id="clearIndexBtn" class="btn btn-danger" onclick="clearIndex()">
            ğŸ—‘ï¸ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        </button>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
/**
 * ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ‰‹å‹•ã§é–‹å§‹ã™ã‚‹
 */
async function startCrawl() {
    if (!confirm('ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
        const response = await fetch('/api/crawl/start', { method: 'POST' });
        const data = await response.json();
        alert(data.message);
        location.reload();
    } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
}

/**
 * å®Ÿè¡Œä¸­ã®ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’åœæ­¢ã™ã‚‹
 */
async function stopCrawl() {
    if (!confirm('ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
        const response = await fetch('/api/crawl/stop', { method: 'POST' });
        const data = await response.json();
        alert(data.message);
        location.reload();
    } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
}

/**
 * ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ã™ã‚‹
 */
async function clearIndex() {
    if (!confirm('æœ¬å½“ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
    if (!confirm('å†åº¦ç¢ºèª: å…¨ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

    try {
        const response = await fetch('/api/index/clear', { method: 'POST' });
        const data = await response.json();
        alert(data.message);
        location.reload();
    } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
}

// ãƒšãƒ¼ã‚¸ã‚’å®šæœŸçš„ã«æ›´æ–°ï¼ˆã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã®çŠ¶æ…‹ã‚’åæ˜ ï¼‰
setInterval(() => {
    // ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã®å ´åˆã®ã¿è‡ªå‹•æ›´æ–°
    const isRunning = document.querySelector('.status-badge.running');
    if (isRunning) {
        location.reload();
    }
}, 30000);  // 30ç§’ã”ã¨
</script>
{% endblock %}
