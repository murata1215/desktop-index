{% extends "base.html" %}
<!--
=============================================================================
Desktop Index - æ¤œç´¢çµæœãƒšãƒ¼ã‚¸
=============================================================================
æ¤œç´¢ã‚¯ã‚¨ãƒªã®çµæœã‚’è¡¨ç¤ºã™ã‚‹ãƒšãƒ¼ã‚¸ã§ã™ã€‚
å„æ¤œç´¢çµæœã«ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã€ãƒ‘ã‚¹ã€ãƒãƒƒãƒã—ãŸãƒ†ã‚­ã‚¹ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
=============================================================================
-->

{% block content %}
<div class="search-results-page">
    <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰ -->
    <form action="/search" method="get" class="search-form-compact">
        <input
            type="text"
            name="q"
            class="search-input-compact"
            value="{{ query }}"
            placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..."
            autofocus
        >
        <button type="submit" class="search-button-compact">æ¤œç´¢</button>
    </form>

    <!-- æ¤œç´¢çµæœæƒ…å ± -->
    {% if query %}
    <div class="search-info">
        <p>
            ã€Œ<strong>{{ query }}</strong>ã€ã®æ¤œç´¢çµæœ:
            <span class="result-count">{{ total_hits }}</span> ä»¶
            <span class="processing-time">({{ processing_time_ms }} ms)</span>
        </p>
    </div>
    {% endif %}

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ -->
    <div class="filter-bar">
        <span class="filter-label">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</span>
        <a href="/search?q={{ query }}" class="filter-chip {% if not request.query_params.get('extension') %}active{% endif %}">ã™ã¹ã¦</a>
        <a href="/search?q={{ query }}&extension=.pdf" class="filter-chip {% if request.query_params.get('extension') == '.pdf' %}active{% endif %}">PDF</a>
        <a href="/search?q={{ query }}&extension=.docx" class="filter-chip {% if request.query_params.get('extension') == '.docx' %}active{% endif %}">Word</a>
        <a href="/search?q={{ query }}&extension=.xlsx" class="filter-chip {% if request.query_params.get('extension') == '.xlsx' %}active{% endif %}">Excel</a>
        <a href="/search?q={{ query }}&extension=.txt" class="filter-chip {% if request.query_params.get('extension') == '.txt' %}active{% endif %}">ãƒ†ã‚­ã‚¹ãƒˆ</a>
    </div>

    <!-- æ¤œç´¢çµæœãƒªã‚¹ãƒˆ -->
    <div class="results-list">
        {% if results %}
            {% for result in results %}
            <div class="result-item">
                <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã¨åå‰ -->
                <div class="result-header">
                    <span class="file-icon">{{ get_file_icon(result.extension) }}</span>
                    <a href="#" class="result-title" onclick="openFile('{{ result.path }}'); return false;">
                        {% if result._formatted and result._formatted.filename %}
                            {{ result._formatted.filename | safe }}
                        {% else %}
                            {{ result.filename }}
                        {% endif %}
                    </a>
                </div>

                <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ -->
                <div class="result-path">
                    <span class="path-text">{{ result.path }}</span>
                    <button class="copy-button" onclick="copyToClipboard('{{ result.path }}')" title="ãƒ‘ã‚¹ã‚’ã‚³ãƒ”ãƒ¼">
                        ğŸ“‹
                    </button>
                </div>

                <!-- ãƒ¡ã‚¿æƒ…å ± -->
                <div class="result-meta">
                    <span class="meta-item">
                        <span class="meta-icon">ğŸ“…</span>
                        {{ result.modified_at[:10] if result.modified_at else 'ä¸æ˜' }}
                    </span>
                    <span class="meta-item">
                        <span class="meta-icon">ğŸ“¦</span>
                        {{ format_file_size(result.size) }}
                    </span>
                    <span class="meta-item">
                        <span class="meta-icon">ğŸ“„</span>
                        {{ result.extension }}
                    </span>
                </div>

                <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ãï¼‰ -->
                {% if result._formatted and result._formatted.content %}
                <div class="result-preview">
                    {{ result._formatted.content | safe }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            {% if query %}
            <div class="no-results">
                <p class="no-results-icon">ğŸ”</p>
                <p class="no-results-text">ã€Œ{{ query }}ã€ã«ä¸€è‡´ã™ã‚‹çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
                <p class="no-results-hint">åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„</p>
            </div>
            {% else %}
            <div class="no-results">
                <p class="no-results-icon">ğŸ’¡</p>
                <p class="no-results-text">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            </div>
            {% endif %}
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/**
 * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãï¼ˆWindowsç”¨ã®ãƒ‘ã‚¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼‰
 * Dockerå†…ã‹ã‚‰ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ãªã„ãŸã‚ã€ãƒ‘ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹å‹•ä½œã«å¤‰æ›´
 *
 * @param {string} path - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
 */
function openFile(path) {
    // Dockerå†…ã®ãƒ‘ã‚¹ã‚’Windowsãƒ‘ã‚¹ã«å¤‰æ›
    // /mnt/c_users â†’ C:/Users
    // /mnt/d_drive â†’ D:/
    let windowsPath = path;
    if (path.startsWith('/mnt/c_users')) {
        windowsPath = path.replace('/mnt/c_users', 'C:/Users');
    } else if (path.startsWith('/mnt/d_drive')) {
        windowsPath = path.replace('/mnt/d_drive', 'D:');
    }
    // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã«å¤‰æ›
    windowsPath = windowsPath.replace(/\//g, '\\');

    copyToClipboard(windowsPath);
    alert('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ:\n' + windowsPath);
}

/**
 * ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
 *
 * @param {string} text - ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
 */
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        console.log('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ:', text);
    }).catch(err => {
        console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
    });
}
</script>
{% endblock %}
